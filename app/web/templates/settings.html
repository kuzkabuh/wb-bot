{% extends "base.html" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
    {% if role %}
      <span class="badge bg-dark text-uppercase">{{ role }}</span>
    {% endif %}
  </div>

  <div class="mx-auto" style="max-width:640px;">
    {% if error %}
      <div class="alert alert-danger" role="alert">{{ error }}</div>
    {% endif %}

    {% if saved %}
      <div class="alert alert-success" role="alert">
        –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ <a href="/check_token" class="alert-link">–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</a>.
      </div>
    {% elif has_key %}
      <div class="alert alert-info" role="alert">
        API-–∫–ª—é—á —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å –µ–≥–æ –Ω–æ–≤—ã–º ‚Äî —Å—Ç–∞—Ä—ã–π –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω.
      </div>
    {% endif %}

    {% if has_key %}
      <a class="btn btn-outline-primary mb-3" href="/check_token">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</a>
    {% endif %}

    <div class="card shadow-sm">
      <div class="card-body">
        <form method="post" action="/settings" id="wb-key-form" class="mt-1" autocomplete="off" novalidate>
          {% if csrf_token %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          {% endif %}

          <div class="mb-3">
            <label class="form-label" for="wb_api_key">WB API-–∫–ª—é—á</label>
            <div class="input-group">
              <input id="wb_api_key"
                     name="wb_api_key"
                     type="password"
                     class="form-control font-monospace"
                     placeholder="–≤—Å—Ç–∞–≤—å—Ç–µ API-–∫–ª—é—á"
                     minlength="10"
                     maxlength="512"
                     required
                     autocomplete="new-password">
              <button class="btn btn-outline-secondary" type="button" id="toggle-visibility" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å">
                üëÅ
              </button>
            </div>
            <div class="form-text">
              –ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ –∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
            </div>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit" id="submit-btn">
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <a class="btn btn-secondary" href="/dashboard">–û—Ç–º–µ–Ω–∞</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const form = document.getElementById('wb-key-form');
      const input = document.getElementById('wb_api_key');
      const btn = document.getElementById('submit-btn');
      const toggle = document.getElementById('toggle-visibility');

      // –¢—Ä–∏–º–∏–º —Å–ª—É—á–∞–π–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ/–æ—Ç–ø—Ä–∞–≤–∫–µ
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text');
        const trimmed = (text || '').trim();
        document.execCommand('insertText', false, trimmed);
      });

      form.addEventListener('submit', () => {
        input.value = (input.value || '').trim();
        btn.disabled = true;
        btn.innerText = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      });

      // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–ª—é—á
      toggle.addEventListener('click', () => {
        input.type = input.type === 'password' ? 'text' : 'password';
      });
    })();
  </script>
{% endblock %}
